<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Chat</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        h1 {
            color: #5a67d8;
        }
        #authSection, #chatSection, #addFriendSection {
            width: 300px;
            background: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #5a67d8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #434190;
        }
        #messages {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .message.user {
            background-color: #d4f0fc;
            text-align: right;
        }
        .message.friend {
            background-color: #e2e8f0;
        }
        .message img {
            max-width: 100%;
            border-radius: 5px;
        }
        #googleSignInBtn {
            background-color: #db4437;
            margin-top: 10px;
        }
        #friendsList {
            margin: 10px 0;
            padding: 10px;
            background-color: #edf2f7;
            border-radius: 5px;
        }
        #friendsList div {
            margin: 5px 0;
            cursor: pointer;
        }
        .selected {
            background-color: #cbd5e0;
        }
    </style>
    <!-- Firebase SDK scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js"></script>
    <!-- Add a favicon placeholder -->
    <link rel="icon" href="data:;base64,=">
</head>
<body>
    <h1>Friend Chat</h1>

    <!-- Registration/Login Forms -->
    <div id="authSection">
        <h2>Register</h2>
        <input type="text" id="registerUsername" placeholder="Username">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password">
        <button onclick="register()">Register</button>

        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>

        <button id="googleSignInBtn" onclick="googleSignIn()">Sign in with Google</button>
    </div>

    <!-- Friend management and messaging -->
    <div id="chatSection" style="display:none;">
        <div id="addFriendSection">
            <h2>Add Friend</h2>
            <input type="email" id="friendEmail" placeholder="Friend's email">
            <button onclick="addFriend()">Add Friend</button>
            <div id="friendsList"></div>
        </div>

        <div id="chatWindow" style="display:none;">
            <h2>Chat</h2>
            <textarea id="messageInput" placeholder="Enter your message" rows="5"></textarea>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="sendMessage()">Send</button>
            <div id="messages"></div>
        </div>
        <button onclick="logout()">Logout</button>
    </div>

    <script type="module">
        // Firebase v9 Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBFLQzHxVw5UV1481iRfruD9AEenf_M_lI",
            authDomain: "realtime-sync-project.firebaseapp.com",
            databaseURL: "https://realtime-sync-project-default-rtdb.firebaseio.com",
            projectId: "realtime-sync-project",
            storageBucket: "realtime-sync-project.appspot.com",
            messagingSenderId: "1079348282119",
            appId: "1:1079348282119:web:57d72c95e6212070fe7ba2",
            measurementId: "G-XKVNBVD6RE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let currentUserId = null;
        let selectedFriendId = null;

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const usernameDoc = await getDoc(doc(firestore, 'usernames', username));
            if (usernameDoc.exists()) {
                alert('Username is already taken!');
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const userId = userCredential.user.uid;
                    await setDoc(doc(firestore, 'usernames', username), { userId });
                    await setDoc(doc(firestore, 'users', userId), { username, email });
                    alert('Registration successful!');
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUserId = userCredential.user.uid;
                    loadFriends();
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function googleSignIn() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(async (result) => {
                    const user = result.user;
                    currentUserId = user.uid;
                    const username = user.displayName;

                    const usernameDoc = await getDoc(doc(firestore, 'usernames', username));
                    if (!usernameDoc.exists()) {
                        await setDoc(doc(firestore, 'usernames', username), { userId: currentUserId });
                        await setDoc(doc(firestore, 'users', currentUserId), { username, email: user.email });
                    }

                    loadFriends();
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function logout() {
            signOut(auth).then(() => {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('chatSection').style.display = 'none';
                currentUserId = null;
            });
        }

        async function addFriend() {
            const friendEmail = document.getElementById('friendEmail').value;
            const q = query(collection(firestore, 'users'), where('email', '==', friendEmail));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const friend = querySnapshot.docs[0];
                const friendId = friend.id;
                await setDoc(doc(firestore, `users/${currentUserId}/friends`, friendId), {});
                await setDoc(doc(firestore, `users/${friendId}/friends`, currentUserId), {});
                loadFriends();
            } else {
                alert('Friend not found!');
            }
        }

        async function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';

            const friendsRef = collection(firestore, `users/${currentUserId}/friends`);
            const friendsSnapshot = await getDocs(friendsRef);

            friendsSnapshot.forEach(async (docSnapshot) => {
                const friendId = docSnapshot.id;
                const friendDoc = await getDoc(doc(firestore, 'users', friendId));
                const friendData = friendDoc.data();
                const friendDiv = document.createElement('div');
                friendDiv.innerHTML = friendData.username;
                friendDiv.onclick = () => selectFriend(friendId);
                friendsList.appendChild(friendDiv);
            });
        }

        function selectFriend(friendId) {
            selectedFriendId = friendId;
            document.getElementById('chatWindow').style.display = 'block';
            loadMessages();
        }

        function loadMessages() {
            const messagesRef = ref(database, `messages/${currentUserId}/${selectedFriendId}`);
            onValue(messagesRef, (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = messageData.sender === currentUserId ? 'message user' : 'message friend';
                    messageDiv.innerHTML = messageData.text || `<img src="${messageData.imageUrl}" />`;
                    messagesDiv.appendChild(messageDiv);
                });
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput').value;
            const imageInput = document.getElementById('imageInput').files[0];

            if (imageInput) {
                const imageRef = storageRef(storage, `images/${Date.now()}_${imageInput.name}`);
                uploadBytes(imageRef, imageInput).then(snapshot => {
                    getDownloadURL(snapshot.ref).then(downloadURL => {
                        pushMessage({ imageUrl: downloadURL });
                    });
                });
            } else {
                pushMessage({ text: messageInput });
            }

            document.getElementById('messageInput').value = '';
            document.getElementById('imageInput').value = '';
        }

        function pushMessage(data) {
            const messagesRef = ref(database, `messages/${currentUserId}/${selectedFriendId}`);
            push(messagesRef, { sender: currentUserId, ...data });
        }
    </script>
</body>
</html>
