<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Chat</title>
    <style>
        /* Styling */
        #userInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
        }

        .message.user {
            text-align: right;
        }

        .message.friend {
            text-align: left;
        }
    </style>
    <!-- Firebase SDK scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage-compat.js"></script>
</head>
<body>
    <h1>Friend Chat</h1>

    <!-- User Info (top-right corner) -->
    <div id="userInfo" style="display:none;">
        <span id="userEmail"></span><br>
        <span id="userUsername"></span>
    </div>

    <!-- Registration/Login Forms -->
    <div id="authSection">
        <h2>Register</h2>
        <input type="text" id="registerUsername" placeholder="Username">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password">
        <button onclick="register()">Register</button>

        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- Friend management and messaging -->
    <div id="chatSection" style="display:none;">
        <div id="addFriendSection">
            <h2>Add Friend by Username</h2>
            <input type="text" id="friendUsername" placeholder="Friend's username">
            <button onclick="addFriend()">Add Friend</button>
            <div id="friendRequestsSection"></div>
            <div id="friendsList"></div>
        </div>

        <div id="chatWindow" style="display:none;">
            <h2>Chat</h2>
            <textarea id="messageInput" placeholder="Enter your message" rows="5"></textarea>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="sendMessage()">Send</button>
            <div id="messages"></div>
        </div>
        <button onclick="logout()">Logout</button>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUserId = null;
        let selectedFriendId = null;

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const usernameDoc = await firestore.collection('usernames').doc(username).get();
            if (usernameDoc.exists) {
                alert('Username is already taken!');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const userId = userCredential.user.uid;
                    await firestore.collection('usernames').doc(username).set({ userId });
                    await firestore.collection('users').doc(userId).set({ username, email });
                    alert('Registration successful!');
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    currentUserId = userCredential.user.uid;
                    const userDoc = await firestore.collection('users').doc(currentUserId).get();
                    const userData = userDoc.data();

                    document.getElementById('userEmail').innerText = userData.email;
                    document.getElementById('userUsername').innerText = userData.username;
                    document.getElementById('userInfo').style.display = 'block';

                    loadFriendRequests();
                    loadFriends();
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function logout() {
            auth.signOut().then(() => {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('chatSection').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                currentUserId = null;
            });
        }

        async function addFriend() {
            const friendUsername = document.getElementById('friendUsername').value;
            const friendDoc = await firestore.collection('usernames').doc(friendUsername).get();

            if (friendDoc.exists) {
                const friendId = friendDoc.data().userId;
                await firestore.collection(`users/${friendId}/friendRequests`).doc(currentUserId).set({
                    status: 'pending'
                });
                alert('Friend request sent!');
            } else {
                alert('Friend not found!');
            }
        }

        async function loadFriendRequests() {
            const friendRequestsSection = document.getElementById('friendRequestsSection');
            friendRequestsSection.innerHTML = '<h2>Friend Requests</h2>';
            
            const friendRequestsSnapshot = await firestore.collection(`users/${currentUserId}/friendRequests`).get();
            
            friendRequestsSnapshot.forEach(async (docSnapshot) => {
                const requesterId = docSnapshot.id;
                const status = docSnapshot.data().status;
                
                if (status === 'pending') {
                    const requesterDoc = await firestore.collection('users').doc(requesterId).get();
                    const requesterData = requesterDoc.data();

                    const requestDiv = document.createElement('div');
                    requestDiv.innerHTML = `${requesterData.username} <button onclick="acceptFriend('${requesterId}')">Accept</button> <button onclick="declineFriend('${requesterId}')">Decline</button>`;
                    friendRequestsSection.appendChild(requestDiv);
                }
            });
        }

        async function acceptFriend(friendId) {
            await firestore.collection(`users/${currentUserId}/friends`).doc(friendId).set({});
            await firestore.collection(`users/${friendId}/friends`).doc(currentUserId).set({});
            await firestore.collection(`users/${currentUserId}/friendRequests`).doc(friendId).delete();
            loadFriends();
        }

        async function declineFriend(friendId) {
            await firestore.collection(`users/${currentUserId}/friendRequests`).doc(friendId).delete();
        }

        async function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<h2>Friends</h2>';

            const friendsSnapshot = await firestore.collection(`users/${currentUserId}/friends`).get();

            friendsSnapshot.forEach(async (docSnapshot) => {
                const friendId = docSnapshot.id;
                const friendDoc = await firestore.collection('users').doc(friendId).get();
                const friendData = friendDoc.data();

                const friendDiv = document.createElement('div');
                friendDiv.innerHTML = friendData.username;
                friendDiv.onclick = () => selectFriend(friendId);
                friendsList.appendChild(friendDiv);
            });
        }

        function selectFriend(friendId) {
            selectedFriendId = friendId;
            document.getElementById('chatWindow').style.display = 'block';
            loadMessages();
        }

        function loadMessages() {
            const messagesRef = database.ref(`messages/${currentUserId}/${selectedFriendId}`);
            messagesRef.on('value', (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = messageData.sender === currentUserId ? 'message user' : 'message friend';
                    messageDiv.innerHTML = messageData.text || `<img src="${messageData.imageUrl}" />`;
                    messagesDiv.appendChild(messageDiv);
                });
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput').value;
            const imageInput = document.getElementById('imageInput').files[0];

            if (imageInput) {
                const imageRef = storage.ref(`images/${Date.now()}_${imageInput.name}`);
                imageRef.put(imageInput).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(downloadURL => {
                        pushMessage({ imageUrl: downloadURL });
                    });
                });
            } else {
                pushMessage({ text: messageInput });
            }

            document.getElementById('messageInput').value = '';
            document.getElementById('imageInput').value = '';
        }

        function pushMessage(data) {
            const messagesRef = database.ref(`messages/${currentUserId}/${selectedFriendId}`);
            messagesRef.push({ sender: currentUserId, ...data });
        }
    </script>
</body>
</html>
