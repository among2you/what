<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Chat</title>
    <style>
        /* Same styles as before */
    </style>
    <!-- Firebase SDK scripts (using the compat build) -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage-compat.js"></script>
</head>
<body>
    <h1>Friend Chat</h1>

    <!-- Registration/Login Forms -->
    <div id="authSection">
        <h2>Register</h2>
        <input type="text" id="registerUsername" placeholder="Username">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password">
        <button onclick="register()">Register</button>

        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>

        <button id="googleSignInBtn" onclick="googleSignIn()">Sign in with Google</button>
    </div>

    <!-- Friend management and messaging -->
    <div id="chatSection" style="display:none;">
        <div id="addFriendSection">
            <h2>Add Friend</h2>
            <input type="email" id="friendEmail" placeholder="Friend's email">
            <button onclick="addFriend()">Add Friend</button>
            <div id="friendsList"></div>
        </div>

        <div id="chatWindow" style="display:none;">
            <h2>Chat</h2>
            <textarea id="messageInput" placeholder="Enter your message" rows="5"></textarea>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="sendMessage()">Send</button>
            <div id="messages"></div>
        </div>
        <button onclick="logout()">Logout</button>
    </div>

    <script>
        // Initialize Firebase (using compat version)
        const firebaseConfig = {
            apiKey: "AIzaSyBFLQzHxVw5UV1481iRfruD9AEenf_M_lI",
            authDomain: "realtime-sync-project.firebaseapp.com",
            databaseURL: "https://realtime-sync-project-default-rtdb.firebaseio.com",
            projectId: "realtime-sync-project",
            storageBucket: "realtime-sync-project.appspot.com",
            messagingSenderId: "1079348282119",
            appId: "1:1079348282119:web:57d72c95e6212070fe7ba2",
            measurementId: "G-XKVNBVD6RE"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const database = firebase.database();
        const storage = firebase.storage();

        let currentUserId = null;
        let selectedFriendId = null;

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const usernameDoc = await firestore.collection('usernames').doc(username).get();
            if (usernameDoc.exists) {
                alert('Username is already taken!');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const userId = userCredential.user.uid;
                    await firestore.collection('usernames').doc(username).set({ userId });
                    await firestore.collection('users').doc(userId).set({ username, email });
                    alert('Registration successful!');
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUserId = userCredential.user.uid;
                    loadFriends();
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    const user = result.user;
                    currentUserId = user.uid;
                    const username = user.displayName;

                    const usernameDoc = await firestore.collection('usernames').doc(username).get();
                    if (!usernameDoc.exists) {
                        await firestore.collection('usernames').doc(username).set({ userId: currentUserId });
                        await firestore.collection('users').doc(currentUserId).set({ username, email: user.email });
                    }

                    loadFriends();
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('chatSection').style.display = 'block';
                })
                .catch(error => alert('Error: ' + error.message));
        }

        function logout() {
            auth.signOut().then(() => {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('chatSection').style.display = 'none';
                currentUserId = null;
            });
        }

        async function addFriend() {
            const friendEmail = document.getElementById('friendEmail').value;
            const querySnapshot = await firestore.collection('users').where('email', '==', friendEmail).get();

            if (!querySnapshot.empty) {
                const friend = querySnapshot.docs[0];
                const friendId = friend.id;
                await firestore.collection(`users/${currentUserId}/friends`).doc(friendId).set({});
                await firestore.collection(`users/${friendId}/friends`).doc(currentUserId).set({});
                loadFriends();
            } else {
                alert('Friend not found!');
            }
        }

        async function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';

            const friendsSnapshot = await firestore.collection(`users/${currentUserId}/friends`).get();

            friendsSnapshot.forEach(async (docSnapshot) => {
                const friendId = docSnapshot.id;
                const friendDoc = await firestore.collection('users').doc(friendId).get();
                const friendData = friendDoc.data();
                const friendDiv = document.createElement('div');
                friendDiv.innerHTML = friendData.username;
                friendDiv.onclick = () => selectFriend(friendId);
                friendsList.appendChild(friendDiv);
            });
        }

        function selectFriend(friendId) {
            selectedFriendId = friendId;
            document.getElementById('chatWindow').style.display = 'block';
            loadMessages();
        }

        function loadMessages() {
            const messagesRef = database.ref(`messages/${currentUserId}/${selectedFriendId}`);
            messagesRef.on('value', (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = messageData.sender === currentUserId ? 'message user' : 'message friend';
                    messageDiv.innerHTML = messageData.text || `<img src="${messageData.imageUrl}" />`;
                    messagesDiv.appendChild(messageDiv);
                });
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput').value;
            const imageInput = document.getElementById('imageInput').files[0];

            if (imageInput) {
                const imageRef = storage.ref(`images/${Date.now()}_${imageInput.name}`);
                imageRef.put(imageInput).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(downloadURL => {
                        pushMessage({ imageUrl: downloadURL });
                    });
                });
            } else {
                pushMessage({ text: messageInput });
            }

            document.getElementById('messageInput').value = '';
            document.getElementById('imageInput').value = '';
        }

        function pushMessage(data) {
            const messagesRef = database.ref(`messages/${currentUserId}/${selectedFriendId}`);
            messagesRef.push({ sender: currentUserId, ...data });
        }
    </script>
</body>
</html>
