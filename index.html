<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging with Firebase</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        h1 {
            color: #5a67d8;
        }
        #authSection, #messageSection {
            width: 300px;
            background: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        input[type="email"], input[type="password"], input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #5a67d8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #434190;
        }
        #messages {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }
        #messages div {
            background: #e2e8f0;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        img {
            max-width: 100%;
            border-radius: 5px;
        }
        #googleSignInBtn {
            background-color: #db4437;
            margin-top: 10px;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- Firebase Authentication SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Messaging</h1>

    <!-- Registration and Login Forms -->
    <div id="authSection">
        <h2>Register</h2>
        <input type="text" id="registerUsername" placeholder="Username"><br>
        <input type="email" id="registerEmail" placeholder="Email"><br>
        <input type="password" id="registerPassword" placeholder="Password"><br>
        <button onclick="register()">Register</button>

        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email"><br>
        <input type="password" id="loginPassword" placeholder="Password"><br>
        <button onclick="login()">Login</button>

        <button id="googleSignInBtn" onclick="googleSignIn()">Sign in with Google</button>
    </div>

    <!-- Form to send message and upload image, visible only when logged in -->
    <div id="messageSection">
        <textarea id="messageInput" placeholder="Enter your message..." rows="5"></textarea><br>
        <input type="file" id="imageInput" accept="image/*"><br>
        <button onclick="sendMessage()">Send</button>
        <button onclick="logout()">Logout</button>
        <h2>Messages</h2>
        <div id="messages"></div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBFLQzHxVw5UV1481iRfruD9AEenf_M_lI",
            authDomain: "realtime-sync-project.firebaseapp.com",
            databaseURL: "https://realtime-sync-project-default-rtdb.firebaseio.com",
            projectId: "realtime-sync-project",
            storageBucket: "realtime-sync-project.appspot.com",
            messagingSenderId: "1079348282119",
            appId: "1:1079348282119:web:57d72c95e6212070fe7ba2",
            measurementId: "G-XKVNBVD6RE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // Register new user with unique username
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            // Check if the username is unique
            const usernameDoc = await firestore.collection('usernames').doc(username).get();
            if (usernameDoc.exists) {
                alert('Username is already taken!');
                return;
            }

            // Create user
            auth.createUserWithEmailAndPassword(email, password)
                .then(async userCredential => {
                    const userId = userCredential.user.uid;
                    
                    // Save username in Firestore
                    await firestore.collection('usernames').doc(username).set({ userId });

                    // Save user info in Firestore
                    await firestore.collection('users').doc(userId).set({ username, email });

                    alert('Registration successful!');
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        // Login existing user
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('messageSection').style.display = 'block';
                    loadMessages(); // Load messages after login
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        // Google Sign-In
        function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    const user = result.user;
                    const userId = user.uid;
                    const username = user.displayName;

                    // Check if username is unique
                    const usernameDoc = await firestore.collection('usernames').doc(username).get();
                    if (!usernameDoc.exists) {
                        // Save username in Firestore
                        await firestore.collection('usernames').doc(username).set({ userId });

                        // Save user info in Firestore
                        await firestore.collection('users').doc(userId).set({ username, email: user.email });
                    }

                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('messageSection').style.display = 'block';
                    loadMessages(); // Load messages after login
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        // Logout user
        function logout() {
            auth.signOut().then(() => {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('messageSection').style.display = 'none';
            }).catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Send a message or image
        async function sendMessage() {
            const userId = auth.currentUser.uid;
            const userDoc = await firestore.collection('users').doc(userId).get();
            const username = userDoc.data().username;

            const message = document.getElementById('messageInput').value;
            const imageInput = document.getElementById('imageInput');
            const imageFile = imageInput.files[0];

            let messageData = {
                userId: userId,
                username: username,
                message: message,
                timestamp: Date.now()
            };

            if (imageFile) {
                // Upload image to Firebase Storage
                const storageRef = storage.ref('images/' + imageFile.name);
                const snapshot = await storageRef.put(imageFile);
                const imageUrl = await snapshot.ref.getDownloadURL();

                // Add image URL to message data
                messageData.imageUrl = imageUrl;
            }

            // Save message to Realtime Database
            messagesRef.push(messageData);

            // Log message in Firestore
            await firestore.collection('userLogs').doc(userId).collection('logs').add(messageData);

            // Clear the input fields
            document.getElementById('messageInput').value = '';
            document.getElementById('imageInput').value = '';
        }

        // Reference to the database path for messages
        const messagesRef = database.ref('messages');

        // Function to load and display messages in real-time
        function loadMessages() {
            messagesRef.on('value', (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = ''; // Clear previous messages

                snapshot.forEach((childSnapshot) => {
                    const childData = childSnapshot.val();

                    // Create message element
                    const messageElement = document.createElement('div');
                    messageElement.style.marginBottom = '20px';

                    if (childData.username && childData.message) {
                        const messageText = document.createElement('p');
                        messageText.textContent = `${childData.username}: ${childData.message}`;
                        messageElement.appendChild(messageText);
                    }

                    if (childData.imageUrl) {
                        const messageImage = document.createElement('img');
                        messageImage.src = childData.imageUrl;
                        messageImage.style.maxWidth = '200px';
                        messageElement.appendChild(messageImage);
                    }

                    messagesDiv.appendChild(messageElement);
                });
            });
        }

        // Check for user authentication state changes
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('messageSection').style.display = 'block';
                loadMessages(); // Load messages for logged-in users
            } else {
                // User is signed out
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('messageSection').style.display = 'none';
            }
        });
    </script>
</body>
</html>
