<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back4app Messaging App</title>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        /* ... (previous CSS remains unchanged) ... */
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="profile-section">
            <span id="userEmail">User Email</span><br>
            <span id="userUsername">Username</span>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search or start new chat">
        </div>

        <div id="friendsList" class="friendsList">
            <!-- List of friends will be dynamically generated -->
        </div>

        <!-- Buttons for login/signup -->
        <div class="login-buttons">
            <button onclick="showLoginForm()">Login</button>
            <button onclick="showSignupForm()">Sign Up</button>
            <button onclick="logout()" id="logoutButton" style="display: none;">Logout</button>
        </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window">
        <div class="chat-header">
            <span id="friendUsername">Friend's Name</span>
        </div>

        <div id="messages" class="messages">
            <!-- Chat messages will be dynamically generated here -->
        </div>

        <div class="chat-footer">
            <textarea id="messageInput" placeholder="Type a message"></textarea>
            <label for="imageInput" class="image-upload-label">ðŸ“·</label>
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Login Form -->
    <div id="loginForm" style="display: none;">
        <input type="text" id="loginUsername" placeholder="Username">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- Signup Form -->
    <div id="signupForm" style="display: none;">
        <input type="text" id="signupUsername" placeholder="Username">
        <input type="email" id="signupEmail" placeholder="Email">
        <input type="password" id="signupPassword" placeholder="Password">
        <button onclick="signup()">Sign Up</button>
    </div>

    <script>
        // Initialize Parse with your credentials
        Parse.initialize("RBcV0nxkkAb1m2pnQe4zuwY7gO6KveMff7i5miZ5", "y8ktwKg2KpEhndlM70fAh32vSjh08hmevvm1MCqp");
        Parse.serverURL = 'https://parseapi.back4app.com/';

        let currentUser = null;
        let currentChatId = null;

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            try {
                currentUser = await Parse.User.logIn(username, password);
                handleLogin(currentUser);
                document.getElementById('loginForm').style.display = 'none';
            } catch (error) {
                alert('Login Error: ' + error.message);
            }
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const user = new Parse.User();
            user.set('username', username);
            user.set('email', email);
            user.set('password', password);
            try {
                await user.signUp();
                currentUser = user;
                handleLogin(currentUser);
                document.getElementById('signupForm').style.display = 'none';
            } catch (error) {
                alert('Signup Error: ' + error.message);
            }
        }

        async function logout() {
            try {
                await Parse.User.logOut();
                currentUser = null;
                document.getElementById('userEmail').innerText = 'User Email';
                document.getElementById('userUsername').innerText = 'Username';
                document.getElementById('friendsList').innerHTML = '';
                document.getElementById('messages').innerHTML = '';
                document.getElementById('logoutButton').style.display = 'none';
                document.querySelector('.login-buttons').style.display = 'block';
            } catch (error) {
                console.error('Logout Error:', error);
            }
        }

        function handleLogin(user) {
            document.getElementById('userEmail').innerText = user.get('email');
            document.getElementById('userUsername').innerText = user.get('username');
            document.getElementById('logoutButton').style.display = 'block';
            document.querySelector('.login-buttons').style.display = 'none';
            loadFriends();
        }

        async function loadFriends() {
            const query = new Parse.Query(Parse.User);
            query.notEqualTo('objectId', currentUser.id);
            try {
                const friends = await query.find();
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = '';
                friends.forEach((friend) => {
                    const friendDiv = document.createElement('div');
                    friendDiv.innerText = friend.get('username');
                    friendDiv.onclick = () => startChat(friend.id, friend.get('username'));
                    friendsList.appendChild(friendDiv);
                });
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function startChat(friendId, friendName) {
            currentChatId = [currentUser.id, friendId].sort().join('_');
            document.getElementById('friendUsername').innerText = friendName;
            loadMessages();
        }

        async function loadMessages() {
            const query = new Parse.Query('Message');
            query.equalTo('chatId', currentChatId);
            query.ascending('createdAt');
            try {
                const messages = await query.find();
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                messages.forEach((message) => {
                    displayMessage(message);
                });
                // Poll for updates every 5 seconds
                setInterval(async () => {
                    const newMessages = await query.find();
                    newMessages.forEach((message) => {
                        if (!document.getElementById(message.id)) {
                            displayMessage(message);
                        }
                    });
                }, 5000);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.id = message.id;
            messageElement.classList.add('message');
            messageElement.classList.add(message.get('senderId') === currentUser.id ? 'user' : 'friend');
            
            if (message.get('type') === 'text') {
                messageElement.innerText = message.get('content');
            } else if (message.get('type') === 'image') {
                const img = document.createElement('img');
                img.src = message.get('content').url();
                img.style.maxWidth = '100%';
                messageElement.appendChild(img);
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const imageInput = document.getElementById('imageInput');
            const file = imageInput.files[0];

            if (message || file) {
                if (file) {
                    await sendImageMessage(file);
                } else {
                    await sendTextMessage(message);
                }
                messageInput.value = '';
                imageInput.value = '';
            }
        }

        async function sendTextMessage(message) {
            const Message = Parse.Object.extend('Message');
            const newMessage = new Message();
            newMessage.set('chatId', currentChatId);
            newMessage.set('senderId', currentUser.id);
            newMessage.set('content', message);
            newMessage.set('type', 'text');
            try {
                await newMessage.save();
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        async function sendImageMessage(file) {
            const parseFile = new Parse.File(file.name, file);
            try {
                await parseFile.save();
                const Message = Parse.Object.extend('Message');
                const newMessage = new Message();
                newMessage.set('chatId', currentChatId);
                newMessage.set('senderId', currentUser.id);
                newMessage.set('content', parseFile);
                newMessage.set('type', 'image');
                await newMessage.save();
            } catch (error) {
                console.error('Error sending image:', error);
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const friendDivs = document.getElementById('friendsList').children;
            for (let friendDiv of friendDivs) {
                if (friendDiv.innerText.toLowerCase().includes(searchTerm)) {
                    friendDiv.style.display = 'block';
                } else {
                    friendDiv.style.display = 'none';
                }
            }
        });

        // Check if user is already logged in
        const currentUser = Parse.User.current();
        if (currentUser) {
            handleLogin(currentUser);
        }
    </script>

</body>
</html>
